var booking_content={};function initDashboard(activePanel,secondaryPanel){sendBookingResponse();initSendPartnerResponse();initDownloadBills();initPanels(activePanel,secondaryPanel);initPagination();initCalendar();initIframe();initUser();initCreatePassword();initCancelProviderOrder();initCreateBusinessQuery();initSendValidationEmail();$(document).click(function(event){if(!$(event.target).closest(".popup-infos").length&&!$(event.target).closest("#menu-tab").length){$(".bloc-element").hide()}});$(".see-waiting-bookings").unbind("click").click(function(){$("#panel-reservedSpaces").click();$("#secondary-panel-validation").click()});initCommission();$(".book-again").unbind("click").click(function(){options={event:"bookPlace",properties:{category:"booking",localization:"dashboard",placeId:$(this).data("place-id"),placeLink:$(this).data("link")}};execAnalytics("track",options)});$("#new-card_submit").unbind("click").click(function(){options={event:"addPaymentMean",properties:{category:"dashboard",paymentMean:"CB"}};execAnalytics("track",options)});$(".sidebar li").click(function(){$(".sidebar > a.mobile").click()})}function initCreatePassword(){$("#create_password_form").unbind("submit").submit(function(e){e.preventDefault();var password=$("#user_new_password").val();var passwordRe=$("#user_new_password_2").val();if(password!=passwordRe){return}$.ajax({method:"post",dataType:"json",url:routingBo("create_password"),data:{password:password}}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}else{$.notify(transLego("ajaxSuccess",{},"messagesJs"),"success");location.reload()}}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})})}function initDownloadBills(){$(".select-bill select").unbind("change").change(function(){var win=window.open(routingBo("download_bills",{type:"fcu",statusName:"finished",year:$(this).val()}),"_blank");win.focus()})}function getBookingsContent(type,state,page,container){if(booking_content[type]&&booking_content[type][state]&&booking_content[type][state][page]){container.html(booking_content[type][state][page]);initPagination();$("html, body").scrollTop(0);return}$.ajax({url:routingBo("load_bookings"),method:"post",dataType:"json",data:{status:state,type:type,page:page}}).done(function(data){if(data.resultCode!=200){$.notify(data.message,"error");return}if(!booking_content[type]){booking_content[type]={}}if(!booking_content[type][state]){booking_content[type][state]={}}booking_content[type][state][page]=data.content;container.html(data.content);$("html, body").scrollTop(0);initPagination()})}function initPagination(){$(".inner-wrap .pagination span").click(function(){var page=$(this).data("page"),type=$(this).data("type"),state=$(this).data("status"),container=$(this).closest(".inner-wrap");getBookingsContent(type,state,page,container)});$(".pagination .pagination-control").unbind("click").click(function(){if($(this).hasClass("disabled")){return false}var active=$(this).parent("li").siblings(".active");var newActive;if($(this).hasClass("control-prev")){newActive=active.prevAll('[role="presentation"]:first')}else if($(this).hasClass("control-next")){newActive=active.nextAll('[role="presentation"]:first')}else if($(this).hasClass("control-first")){newActive=$(this).parent("li").siblings('[data-row="1"]')}else if($(this).hasClass("control-last")){newActive=$(this).parent("li").siblings('[role="presentation"]:last')}else{return false}newActive.tab("show");refreshPaginationButton()});$(".pagination").on("shown.bs.tab",function(e){var row=$(this).find("li.active").data("row");var tabs=$(this).find('li[role="presentation"]');tabs.addClass("hidden");tabs.each(function(){if(tabs.length<=7){$(this).removeClass("hidden");return null}if(row==1&&$(this).data("row")<=3){$(this).removeClass("hidden");return null}if(row==tabs.length&&$(this).data("row")>=row-2){$(this).removeClass("hidden");return null}if($(this).data("row")>=row-1&&$(this).data("row")<=row+1){$(this).removeClass("hidden");return null}if($(this).data("row")<=3||$(this).data("row")>=tabs.length-2){$(this).removeClass("hidden");return null}if(row-2==4&&row-2==$(this).data("row")||row+2==tabs.length-3&&row+2==$(this).data("row")){$(this).removeClass("hidden");return null}});var nbPrev=row-2;if(row==tabs.length){nbPrev=row-3}var rowBefore=tabs.find('[data-row="'+nbPrev+'"]').addBack('[data-row="'+nbPrev+'"]');if(rowBefore.length==1&&rowBefore.hasClass("hidden")){$(".paginiation-place-holder.first").removeClass("hidden").insertAfter(rowBefore)}else{$(".paginiation-place-holder.first").addClass("hidden")}var nbNext=row+2;if(row==1){nbNext=row+3}var rowAfter=tabs.find('[data-row="'+nbNext+'"]').addBack('[data-row="'+nbNext+'"]');if(rowAfter.length==1&&rowAfter.hasClass("hidden")){$(".paginiation-place-holder.second").removeClass("hidden").insertBefore(rowAfter)}else{$(".paginiation-place-holder.second").addClass("hidden")}refreshPaginationButton()});refreshPaginationButton()}function refreshPaginationButton(){$(".pagination").each(function(){var active=$(this).find(".active");var tabs=$(this).find('[role="presentation"]');if(active.data("row")!=1){$(this).find(".control-prev").removeClass("disabled");$(this).find(".control-first").removeClass("disabled")}else{$(this).find(".control-prev").addClass("disabled");$(this).find(".control-first").addClass("disabled")}if(active.data("row")!=tabs.length){$(this).find(".control-next").removeClass("disabled");$(this).find(".control-last").removeClass("disabled")}else{$(this).find(".control-next").addClass("disabled");$(this).find(".control-last").addClass("disabled")}})}function sendBookingResponse(){$(".send-booking-response").unbind("click").click(function(){var action=$(this).data("value");var booking=$(this).data("booking");if(action=="refuse"||action=="accept"){$.ajax({url:routingBo("booking_change_status"),data:{action:action,bookingId:booking},method:"POST",dataType:"json"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}location.reload()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})}else{$.ajax({url:routingBo("booking_get_cancellation_policies"),data:{bookingId:booking},method:"POST",dataType:"json"}).done(function(data){if(200==data.resultCode){$("body").append(data.content);$("#cancel-dialog").modal();$("#confirm-cancel").unbind("click").click(function(){$.ajax({url:routingBo("booking_change_status"),data:{action:action,bookingId:booking,password:$("#password").val()},method:"POST",dataType:"json"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}location.reload()}).fail(function(data){$.notify(data.message,data.notification)})})}}).fail(function(data){$.notify(data.message,data.notification)})}})}function initIframe(){$(".wrap-generate").unbind("change").change(function(){generateIframe()});$(".copy-iframe").unbind("click").click(function(){var copySuccess=copyTextToClipboard($(".iframe-link").text());if("successful"==copySuccess){var iframeLink=$(".iframe-link");var oldText=iframeLink.text();iframeLink.text(transLego("copied"));setTimeout(function(){iframeLink.text(oldText)},3e3)}});$("#iframe-language, #width, #height, #image, #msg, #iframe-search, #iframe-filter").unbind("change").change(function(){updateIframe()});if(undefined!=document.getElementById("iframe-address")){var autocomplete=new google.maps.places.Autocomplete(document.getElementById("iframe-address"),{types:["geocode"]});google.maps.event.addListener(autocomplete,"place_changed",function(){var place=autocomplete.getPlace();$("#lat").val(place.geometry.location.lat());$("#lng").val(place.geometry.location.lng());updateIframe()})}}function generateIframe(){$.ajax({url:routingBo("dashboard_generate_iframe")}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}else{$.notify(transLego("ajaxSuccess",{},"messagesJs"),"success")}location.reload()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})}var updateIframe=$.debounce(500,function(){var updateArray={language:$("#iframe-language").val(),width:$("#width").val(),height:$("#height").val(),gpsLat:$("#lat").val(),gpsLng:$("#lng").val(),address:$("#iframe-address").val(),imageUrl:$("#image").val(),textInfoBooking:$("#msg").val()};if($("#iframe-filter").is(":checked")){updateArray.showFilter=1}else{updateArray.showFilter=0}if($("#iframe-search").is(":checked")){updateArray.showSearch=1}else{updateArray.showSearch=0}$.ajax({url:routingBo("dashboard_update_iframe"),data:{updateArray:updateArray},dataType:"json",type:"POST"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}$.notify(transLego("ajaxSuccess",{},"messagesJs"),"success");$(".iframe-link").text('<iframe width="'+data.width+'" height="'+data.height+'" style="border:none" src="'+data.url+'"></iframe>')}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})});function initRibForm(popUp){var addNewRibConfirm=$(".add-new-rib-confirm");var ribForm=$("form[name=rib-form]");addNewRibConfirm.unbind("click").click(function(){ribForm.submit()});ribForm.unbind("keypress").keypress(function(e){if(e.which==13){ribForm.submit()}});ribForm.unbind("submit").submit(function(){ribForm.submit(function(){return false});var validIban=validateIban($("form[name=rib-form] .iban").val());var validBic=/^[a-zA-Z]{6}[a-zA-Z0-9]{2}[a-zA-Z0-9]{0,3}$/.exec($("form[name=rib-form] .bic").val());if(!validIban){$(".code-iban").addClass("has-error");$("#code").addClass("error")}else{$(".code-iban").removeClass("has-error");$("#code").removeClass("error")}if(!validBic){$(".code-bic").addClass("has-error");$("#bic").addClass("error")}else{$(".code-bic").removeClass("has-error");$("#bic").removeClass("error")}if(!validIban||!validBic){initRibForm(popUp);return false}disableElement(addNewRibConfirm,true);$.ajax({url:routingBo("edit_user_add_rib_ajax"),data:$(this).serialize(),dataType:"json",method:"post"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}options={event:"addPaymentMean",properties:{category:"dashboard",paymentMean:"RIB"}};execAnalytics("track",options);popUp.modal("hide");$(".bank-infos-list").html(data.htmlContent)}).always(function(){disableElement(addNewRibConfirm,false);initRibForm(popUp)}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")});return false})}function initUser(){var dashboardUserProfil=$("form[name=dashboard_user_profil]");dashboardUserProfil.unbind("submit").submit(function(){dashboardUserProfil.submit(function(){return false});if(!dashboardUserProfil.valid()){return false}disableElement($("#dashboard_user_profil_submit"),true);$.ajax({url:routingBo("edit_user_ajax"),data:$(this).serialize(),dataType:"json",method:"post"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}$.notify(transLego("ajaxSuccess",{},"messagesJs"),"success");var dashboardUserProfilFirstName=$("#dashboard_user_profil_firstName");$(".user-names").text(dashboardUserProfilFirstName.val().charAt(0).toUpperCase()+dashboardUserProfilFirstName.val().slice(1).toLowerCase()+". "+$("#dashboard_user_profil_lastName").val().charAt(0).toUpperCase())}).always(function(data){if(data._token){$("#dashboard_user_profil__token").val(data._token)}disableElement($("#dashboard_user_profil_submit"),false);initUser()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")});return false});var dashboardUserBilling=$("form[name=dashboard_user_billing]");dashboardUserBilling.validate({rules:{"dashboard_user_billing[company][companyInfo][address][address1]":{address:{optional:false}},"dashboard_user_billing[company][companyInfo][address][address2]":{address:{optional:true}}},messages:{"dashboard_user_billing[company][companyInfo][address][address1]":{address:transLego("validation.address",{},"messagesJs")},"dashboard_user_billing[company][companyInfo][address][address2]":{address:transLego("validation.address",{},"messagesJs")}}});dashboardUserBilling.unbind("submit").submit(function(){dashboardUserBilling.submit(function(){return false});if(!dashboardUserBilling.valid()){return false}disableElement($("#dashboard_user_billing_submit"),true);$.ajax({url:routingBo("edit_user_ajax"),data:$(this).serialize(),dataType:"json",method:"post"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}$.notify(transLego("ajaxSuccess",{},"messagesJs"),"success")}).always(function(data){if(data._token){$("#dashboard_user_billing__token").val(data._token)}disableElement($("#dashboard_user_billing_submit"),false);initUser()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")});return false});var dashboardUserPassword=$("form[name=dashboard_user_password]");dashboardUserPassword.unbind("submit").submit(function(){dashboardUserPassword.submit(function(){return false});if(!dashboardUserPassword.valid()){return false}disableElement($("#dashboard_user_password_submit"),true);$.ajax({url:routingBo("edit_user_ajax"),data:$(this).serialize(),dataType:"json",method:"post"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}dashboardUserPassword.find("input[type=password]").val("");$.notify(transLego("ajaxSuccess",{},"messagesJs"),"success")}).always(function(data){if(data._token){$("#dashboard_user_password__token").val(data._token)}disableElement($("#dashboard_user_password_submit"),false);initUser()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")});return false});var addNewRib=$(".add-new-rib");addNewRib.unbind("click").click(function(){addNewRib.unbind("click");var popUpId=createPopup("md",{button:"submit",class:"add-new-rib-confirm",confirmButton:".addBankDetails"});var popUp=$("#popup-"+popUpId);var template=Twig.render(displayAddNewRibPopUp,{});popUp.addClass("modal-add-item");popUp.find(".modal-body").html(template);popUp.modal("show");popUp.on("hidden.bs.modal",function(){popUp.remove();initUser()});initRibForm(popUp)});var newCardForm=$("form[name=new-card]");newCardForm.unbind("submit").submit(function(){newCardForm.submit(function(){return false});if(!newCardForm.valid()){return false}disableElement($("#add_new_card_submit"),true);$.ajax({url:routingBo("edit_user_add_card_ajax"),data:$(this).serialize(),dataType:"json",method:"post"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}var titleLabelNoCard=$(".title-label.no-card");if(!titleLabelNoCard.hasClass("hidden")){titleLabelNoCard.addClass("hidden");$(".title-label.cards").removeClass("hidden")}if(null!==data.htmlContent){$(".cards-list").append(data.htmlContent)}newCardForm.find("input").val("");$.notify(transLego("ajaxSuccess",{},"messagesJs"),"success")}).always(function(data){if(data._token){$("#new-card__token").val(data._token)}disableElement($("#add_new_card_submit"),false);initUser()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")});return false});var newPrelForm=$("form[name=new-prel]");newPrelForm.unbind("submit").submit(function(){newPrelForm.submit(function(){return false});if(0<newPrelForm.find("#iban-card").val().length){if(!validateIban(newPrelForm.find("#iban-card").val())){newPrelForm.find(".iban-container").addClass("has-error");return false}newPrelForm.find(".has-error").removeClass("has-error")}else{var codeBankValid=validRegex(/^[a-zA-Z0-9 _-]+$/,newPrelForm.find("#code-bank"));var accountValid=validRegex(/^[a-zA-Z0-9 _-]+$/,newPrelForm.find("#account"));var countryValid=validRegex(/^[a-z]{2}$/,newPrelForm.find("#country"));var guichetValid=validRegex(/^[a-zA-Z0-9 _-]+$/,newPrelForm.find("#guichet"));if(!codeBankValid||!accountValid||!countryValid||!guichetValid){newPrelForm.find(".iban-container").addClass("has-error");return false}newPrelForm.find(".iban-container").removeClass("has-error")}disableElement($("#add_new_prel_submit"),true);$.ajax({url:routingBo("edit_user_add_prel_ajax"),data:$(this).serialize(),dataType:"json",method:"post"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}var titleLabelNoTransfer=$(".title-label.no-transfer");if(!titleLabelNoTransfer.hasClass("hidden")){titleLabelNoTransfer.addClass("hidden");$(".title-label.transfers").removeClass("hidden")}if(null!==data.htmlContent){$(".transfers-list").append(data.htmlContent)}newPrelForm.find("input").val("");$.notify(transLego("ajaxSuccess",{},"messagesJs"),"success")}).always(function(){disableElement($("#add_new_prel_submit"),false);initUser()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")});return false})}function initCommission(){$("#payment-year").unbind("change").change(function(){$("#global-link").attr("href",routingBo("dashboard_reserved_spaces_download_commission",{partnerPaymentIds:$(this).val()}))})}function initCancelProviderOrder(){$(".default-tooltip").tooltip();$(".cancel-provider-order").unbind("click").click(function(){var text="";if(null!=$(this).data("refund")&&null!=$(this).data("paid")){text=transLego("provider.paidAndRefund",{},"messagesJs")}else if(null!=$(this).data("refund")&&null==$(this).data("paid")||null==$(this).data("refund")&&null==$(this).data("paid")){text=transLego("provider.notPaid",{},"messagesJs")}else if(null==$(this).data("refund")){text=transLego("provider.paidNoRefund",{},"messagesJs")}text+="<br />"+transLego("provider.doYouCancel",{},"messagesJs");confirmBo(transLego("provider.titleCancellation",{},"messagesJs"),text,cancelProviderOrder,$(this))})}function cancelProviderOrder(domObject){var orderId=domObject.data("order");$.ajax({method:"post",dataType:"json",url:routingBo("provider_cancel_order"),data:{orderId:orderId}}).done(function(data){if(200==data.resultCode){$("#order-"+orderId).remove()}}).fail(function(data){$.notify(data.message,data.notification)})}function initSendValidationEmail(){$("#send-validation-email").unbind("click").click(function(){$.ajax({url:routingBo("send_user_validation"),data:{},type:"POST",dataType:"json"}).done(function(data){window.location=routingBo("deconnection")}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})})}
function initImportCalendar(){$(".import-calendars").unbind("click").click(function(){$.ajax({url:routingBo("sync_calendar"),method:"POST",dataType:"json",data:{}}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}$("#list-calendar").html(data.content);initEditCalendar();initRemoveCalendar()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})})}function initEditCalendar(){$(".edit-calendar").unbind("click").click(function(){var id=$(this).data("id");$.ajax({url:routingBo("edit_calendar",{calendarId:id}),method:"POST",dataType:"json",data:{}}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}var modal=$("#modal-edit-calendar");modal.find(".modal-body").html(data.content);modal.modal("show");modal.unbind("hidden.bs.modal").on("hidden.bs.modal",function(){modal.find(".modal-body").html("")});initFormEditCalendar(id)}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})})}function initFormEditCalendar(id){var modal=$("#modal-edit-calendar");$("#submit-contact").unbind("click").click(function(){modal.find("form").submit()});modal.find("form").unbind("submit").submit(function(e){e.preventDefault();var fd=new FormData(modal.find("form")[0]);$.ajax({url:routingBo("edit_calendar",{calendarId:id}),method:"POST",dataType:"json",data:fd,processData:false,contentType:false}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}if(data.resultCode==200&&data.saved==true){$("#list-calendar").html(data.content);initEditCalendar();initRemoveCalendar();modal.modal("hide")}}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})})}function initRemoveCalendar(){$(".remove-calendar").unbind("click").click(function(){$.ajax({url:routingBo("remove_calendar"),data:{calendarId:$(this).data("id")},method:"POST",dataType:"json"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}$("#list-calendar").html(data.content);initEditCalendar();initRemoveCalendar()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})})}function initGoogleButtons(){$(".disconnect-google-calendar").unbind("click").click(function(){$.ajax({url:routingBo("disconnect_google_calendar"),method:"POST",dataType:"json"}).done(function(data){if(data.resultCode==200){location.reload()}})});$(".dissociate-google-calendar").unbind("click").click(function(){$.ajax({url:routingBo("dissociate_google_calendars"),method:"POST",dataType:"json"}).done(function(data){if(200!=data.resultCode){$.notify(data.message,data.notification);return false}$("#list-calendar").html(data.content);initEditCalendar();initRemoveCalendar()}).fail(function(){$.notify(transLego("ajaxFailure",{},"messagesJs"),"error")})})}function initCalendar(){initGoogleButtons();initImportCalendar();initEditCalendar();initRemoveCalendar()}
$(function(){var labelWasClicked=function labelWasClicked(){var input=$(this).siblings().filter("input");if(input.attr("disabled")){return}input.val($(this).attr("data-value"))};var turnToStar=function turnToStar(){if($(this).find("input").attr("disabled")){return}var labels=$(this).find("div");labels.removeClass();labels.addClass("star")};var turnStarBack=function turnStarBack(){var rating=parseInt($(this).find("input").val());if(rating>0){var selectedStar=$(this).children().filter("#rating_star_"+rating);var prevLabels=$(selectedStar).nextAll();prevLabels.removeClass();prevLabels.addClass("star-full");selectedStar.removeClass();selectedStar.addClass("star-full")}};$(".star, .rating-well").click(labelWasClicked);$(".rating-well").each(turnStarBack);$(".rating-well").hover(turnToStar,turnStarBack)});